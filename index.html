<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowState - Financial Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #0a0f1a;
            --foreground: #f0f4f8;
            --card-bg: rgba(16, 24, 39, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.3);
            --accent-soft: rgba(16, 185, 129, 0.15);
            --danger: #ef4444;
            --warning: #f59e0b;
            --muted: #64748b;
            --input-bg: rgba(30, 41, 59, 0.8);
            --overlay-bg: rgba(0, 0, 0, 0.6);
        }

        body {
            background: var(--background);
            background-image:
                radial-gradient(ellipse at top, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            color: var(--foreground);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Glassmorphism Card */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.2),
                0 2px 4px -2px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
        }

        .overlay-backdrop {
            background: var(--overlay-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .input-field {
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--foreground);
            font-size: 16px;
            transition: all 0.2s ease;
            outline: none;
            width: 100%;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #059669 100%);
            color: white;
            font-weight: 600;
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 14px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--muted);
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--foreground);
        }

        .transaction-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .transaction-item:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: var(--card-border);
            transform: translateX(4px);
        }

        .category-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Animation classes */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Progress Ring */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.5s ease; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // --- STORAGE UTILS ---
        const STORAGE_KEY = 'flowstate_data';
        
        const categoryKeywords = {
            'Food': ['starbucks', 'mcdonalds', 'subway', 'chipotle', 'pizza', 'burger', 'restaurant', 'cafe', 'coffee', 'lunch', 'dinner', 'breakfast', 'groceries', 'walmart', 'costco', 'trader', 'whole foods', 'doordash', 'ubereats', 'grubhub'],
            'Utilities': ['shell', 'gas', 'electric', 'water', 'internet', 'phone', 'verizon', 'att', 't-mobile', 'comcast', 'xfinity', 'pg&e', 'utility', 'bill'],
            'Transport': ['uber', 'lyft', 'taxi', 'bus', 'metro', 'train', 'gas station', 'chevron', 'exxon', 'mobil', 'parking', 'toll'],
            'Entertainment': ['netflix', 'spotify', 'hulu', 'disney', 'hbo', 'amazon prime', 'movie', 'concert', 'game', 'steam', 'playstation', 'xbox', 'nintendo'],
            'Shopping': ['amazon', 'target', 'best buy', 'apple', 'nike', 'adidas', 'zara', 'h&m', 'clothes', 'shoes', 'electronics'],
            'Health': ['pharmacy', 'cvs', 'walgreens', 'doctor', 'hospital', 'gym', 'fitness', 'medicine', 'dental', 'vision'],
            'Subscriptions': ['subscription', 'membership', 'monthly', 'annual', 'premium'],
            'Income': ['salary', 'paycheck', 'bonus', 'freelance', 'income', 'payment received', 'deposit'],
            'Other': []
        };

        const categoryColors = {
            'Food': 'bg-orange-500/20 text-orange-400',
            'Utilities': 'bg-blue-500/20 text-blue-400',
            'Transport': 'bg-purple-500/20 text-purple-400',
            'Entertainment': 'bg-pink-500/20 text-pink-400',
            'Shopping': 'bg-yellow-500/20 text-yellow-400',
            'Health': 'bg-red-500/20 text-red-400',
            'Subscriptions': 'bg-indigo-500/20 text-indigo-400',
            'Income': 'bg-emerald-500/20 text-emerald-400',
            'Other': 'bg-gray-500/20 text-gray-400'
        };

         const categoryHexColors = {
            'Food': '#f97316',
            'Utilities': '#3b82f6',
            'Transport': '#a855f7',
            'Entertainment': '#ec4899',
            'Shopping': '#eab308',
            'Health': '#ef4444',
            'Subscriptions': '#6366f1',
            'Income': '#10b981',
            'Other': '#6b7280'
        };

        function getDefaultData() {
            return {
                transactions: [],
                settings: { monthlyBudget: 3000, savingsGoal: 5000, accentColor: 'emerald' }
            };
        }

        function getData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : getDefaultData();
            } catch (e) {
                return getDefaultData();
            }
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            renderApp(); // Re-render on save
        }

        // --- APP STATE ---
        let state = {
            showOverlay: true,
            selectedMonth: new Date().getMonth(),
            editingTransaction: null,
            expandedId: null,
            showSettings: false,
            // Settings Edit State
            editBudget: '',
            editSavingsGoal: '',
             // Transaction Form State
            form: {
                title: '', amount: '', category: 'Other', comment: '', type: 'expense', date: new Date().toISOString().split('T')[0]
            }
        };

        // --- RENDER FUNCTIONS ---
        const app = document.getElementById('app');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const fullMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        function renderApp() {
            const data = getData();
            const transactions = data.transactions;
            const settings = data.settings;
            
            // Calculations
            const currentYear = new Date().getFullYear();
            const monthTransactions = transactions.filter(t => {
                const d = new Date(t.createdAt);
                return d.getMonth() === state.selectedMonth && d.getFullYear() === currentYear;
            });
            const monthlySpending = monthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const progress = Math.min((monthlySpending / settings.monthlyBudget) * 100, 100);
            const remaining = settings.monthlyBudget - monthlySpending;

            // EOY Data
            const eoyData = Array(12).fill(null).map((_, i) => ({ month: i, income: 0, expenses: 0, savings: 0 }));
            transactions.filter(t => new Date(t.createdAt).getFullYear() === currentYear).forEach(t => {
                 const m = new Date(t.createdAt).getMonth();
                 if(t.type === 'income') eoyData[m].income += t.amount;
                 else eoyData[m].expenses += t.amount;
            });
            let cumulative = 0;
            eoyData.forEach(m => { m.savings = m.income - m.expenses; cumulative += m.savings; m.cumulative = cumulative; });
            // Total Saved (positive months only logic from React)
            const totalSaved = eoyData.slice(0, new Date().getMonth() + 1).reduce((sum, d) => sum + Math.max(d.savings, 0), 0);
            const savingsProgress = Math.min((totalSaved / settings.savingsGoal) * 100, 100);

            // Pie Chart Data
            const categoryBreakdown = monthTransactions.filter(t => t.type === 'expense').reduce((acc, t) => {
                const existing = acc.find(c => c.category === t.category);
                if (existing) existing.amount += t.amount;
                else acc.push({category: t.category, amount: t.amount});
                return acc;
            }, []).sort((a,b) => b.amount - a.amount);

            // --- HTML GENERATION ---
            let html = `
            <div class="min-h-screen pb-24 relative">
                ${renderSettingsModal(state.showSettings, settings)}
                ${renderOverlay(state.showOverlay)}
                ${renderHeader()}
                
                <div class="px-4 grid grid-cols-1 md:grid-cols-2 gap-6 pb-24">
                    <div class="glass-card p-6 md:col-span-2">
                        <h2 class="text-lg font-semibold text-white mb-4">EOY Savings</h2>
                        ${renderSavingsChart(eoyData, settings.savingsGoal, totalSaved, savingsProgress)}
                    </div>

                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-white">${fullMonths[state.selectedMonth]} Budget</h2>
                            <span class="text-sm text-gray-400">$${settings.monthlyBudget.toLocaleString()}</span>
                        </div>
                        <div class="flex flex-col items-center">
                            ${renderProgressRing(progress)}
                            <div class="mt-4 flex items-center gap-6">
                                <div class="text-center">
                                    <p class="text-sm text-gray-400">Spent</p>
                                    <p class="text-xl font-semibold text-white">$${monthlySpending.toFixed(2)}</p>
                                </div>
                                <div class="w-px h-10 bg-gray-700"></div>
                                <div class="text-center">
                                    <p class="text-sm text-gray-400">Remaining</p>
                                    <p class="text-xl font-semibold ${remaining >= 0 ? 'text-emerald-400' : 'text-danger'}">$${remaining.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6">
                        <h2 class="text-lg font-semibold text-white mb-4">${fullMonths[state.selectedMonth]} Spending</h2>
                        ${renderPieChart(categoryBreakdown)}
                    </div>

                    <div class="glass-card p-6 md:col-span-2">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-white">${fullMonths[state.selectedMonth]} Transactions</h2>
                            <span class="text-sm text-gray-400">${monthTransactions.length} total</span>
                        </div>
                        ${renderTransactionsList(monthTransactions)}
                    </div>
                </div>

                <button onclick="toggleOverlay(true)" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-500/30 hover:scale-110 transition-transform z-40">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
            `;

            app.innerHTML = html;
        }

        // --- SUB-RENDERERS ---

        function renderHeader() {
            return `
            <header class="pt-12 pb-6 px-6 flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white">FlowState</h1>
                    <p class="text-gray-400 mt-1">Track your financial flow</p>
                </div>
                <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-gray-800/50 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700/50 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </header>
            `;
        }

        function renderSavingsChart(data, goal, totalSaved, progress) {
            const currentMonth = new Date().getMonth();
            const monthlySavings = data.map(d => Math.max(d.savings || 0, 0));
            const maxVal = Math.max(...monthlySavings.slice(0, currentMonth + 1), 1);
            
            const barsHtml = months.map((m, i) => {
                const saving = monthlySavings[i];
                const height = maxVal > 0 ? (saving/maxVal)*100 : 0;
                const isSelected = i === state.selectedMonth;
                const isPast = i <= currentMonth;
                
                let barClass = isSelected ? 'bg-gradient-to-t from-cyan-500 to-cyan-300 shadow-[0_0_16px_rgba(6,182,212,0.6)]' :
                               isPast ? 'bg-gradient-to-t from-emerald-600 to-emerald-400' : 'bg-gray-600';
                               
                return `
                <div class="flex-1 flex flex-col items-center gap-1 cursor-pointer group" onclick="selectMonth(${i})">
                    <div class="w-full rounded-t-md transition-all duration-300 ${barClass}" 
                         style="height: ${isPast ? Math.max(height, 8) : 8}px; opacity: ${isSelected?1:isPast?0.7:0.4}"></div>
                    <span class="text-[10px] ${isSelected?'text-cyan-400 font-bold':'text-gray-400'}">${m}</span>
                </div>`;
            }).join('');

            return `
            <div class="w-full">
                <p class="text-xs text-gray-500 text-center mb-3">Tap a month to view details</p>
                <div class="flex items-end justify-between gap-1.5 h-28 px-1 mb-2">
                    ${barsHtml}
                </div>
                <div class="mt-4 space-y-3">
                    <div class="space-y-1.5">
                        <div class="flex justify-between text-sm"><span class="text-gray-400">Progress</span><span class="font-semibold text-emerald-400">${Math.round(progress)}%</span></div>
                        <div class="h-3 bg-gray-700/50 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-400 rounded-full transition-all duration-700" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div><p class="text-2xl font-bold text-white">$${totalSaved.toLocaleString()}</p><p class="text-xs text-gray-400">saved so far</p></div>
                        <div class="text-right"><p class="text-lg font-semibold text-gray-300">$${Math.max(goal - totalSaved, 0).toLocaleString()}</p><p class="text-xs text-gray-400">left to reach $${goal.toLocaleString()}</p></div>
                    </div>
                </div>
            </div>`;
        }

        function renderProgressRing(pct) {
            const size = 180, stroke=12;
            const r = (size - stroke)/2;
            const param = 2 * Math.PI * r;
            const offset = param - (Math.min(pct, 100)/100) * param;
            let color = pct < 50 ? '#10b981' : pct < 75 ? '#f59e0b' : '#ef4444';

            return `
            <div class="relative" style="width:${size}px; height:${size}px">
                <svg class="progress-ring" width="${size}" height="${size}">
                    <circle stroke="rgba(255,255,255,0.1)" stroke-width="${stroke}" fill="transparent" r="${r}" cx="${size/2}" cy="${size/2}"/>
                    <circle class="progress-ring__circle" stroke="${color}" stroke-width="${stroke}" stroke-linecap="round" fill="transparent" r="${r}" cx="${size/2}" cy="${size/2}" style="stroke-dasharray: ${param}; stroke-dashoffset: ${offset}; filter: drop-shadow(0 0 8px ${color}40)"/>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-3xl font-bold text-white">${Math.round(pct)}%</span>
                    <span class="text-sm text-gray-400">of budget</span>
                </div>
            </div>`;
        }

        function renderPieChart(data) {
            const total = data.reduce((s, c) => s + c.amount, 0);
            if(total === 0) return `<div class="text-center py-8 text-gray-400">No expenses this month</div>`;
            
            let currentAngle = 0;
            const paths = data.map(slice => {
                const angle = (slice.amount / total) * 360;
                const start = currentAngle;
                const end = currentAngle + angle;
                currentAngle += angle;
                
                // SVG Path calc
                const r = 80;
                const x1 = 100 + r * Math.cos((start-90)*Math.PI/180);
                const y1 = 100 + r * Math.sin((start-90)*Math.PI/180);
                const x2 = 100 + r * Math.cos((end-90)*Math.PI/180);
                const y2 = 100 + r * Math.sin((end-90)*Math.PI/180);
                const large = angle > 180 ? 1 : 0;
                const d = `M 100 100 L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
                
                return `<path d="${d}" fill="${categoryHexColors[slice.category]||'#6b7280'}" />`;
            }).join('');

            const legend = data.map(s => `
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" style="background:${categoryHexColors[s.category]||'#666'}"></div>
                    <span class="text-xs text-gray-400 truncate w-20">${s.category}</span>
                    <span class="text-xs text-white ml-auto">${Math.round((s.amount/total)*100)}%</span>
                </div>`).join('');

            return `
            <div class="flex flex-col items-center">
                <div class="relative">
                    <svg width="200" height="200" viewBox="0 0 200 200">${paths}<circle cx="100" cy="100" r="50" fill="var(--background)"/></svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-white font-bold">$${total.toFixed(0)}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-4 w-full max-w-xs">${legend}</div>
            </div>`;
        }

        function renderTransactionsList(transactions) {
            if(transactions.length === 0) return '<div class="text-center py-8 text-gray-400">No transactions this month</div>';
            
            const sorted = [...transactions].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            return `<div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                ${sorted.map(t => {
                    const isIncome = t.type === 'income';
                    const expanded = state.expandedId === t.id;
                    return `
                    <div class="transaction-item group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleExpand('${t.id}')">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center ${isIncome?'bg-emerald-500/20 text-emerald-400':'bg-gray-700 text-gray-400'}">
                                    ${isIncome ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>' : 
                                                 '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>'}
                                </div>
                                <div>
                                    <p class="font-medium text-white truncate text-sm">${t.title}</p>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <span class="category-badge ${categoryColors[t.category]||'text-gray-400 bg-gray-700'}">${t.category}</span>
                                        <span class="text-xs text-gray-500">${new Date(t.createdAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-semibold ${isIncome?'text-emerald-400':'text-white'}">${isIncome?'+':'-'}$${t.amount.toFixed(2)}</span>
                                <button onclick="deleteTx('${t.id}')" class="text-red-400 hover:bg-red-500/10 p-1.5 rounded-full transition-colors"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </div>
                        ${expanded ? `<div class="mt-3 pt-3 border-t border-white/10 text-sm text-gray-300 animate-fade-in">${t.comment || '<em class="text-gray-500">No comment</em>'}</div>` : ''}
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderOverlay(isOpen) {
            if(!isOpen) return '';
            const cats = Object.keys(categoryKeywords);
            return `
            <div class="fixed inset-0 z-50 overlay-backdrop flex items-center justify-center p-4 animate-fade-in" onclick="if(event.target===this) toggleOverlay(false)">
                <div class="glass-card w-full max-w-md animate-slide-up max-h-[90vh] flex flex-col">
                    <div class="flex items-center justify-between p-6 pb-4 border-b border-white/10">
                        <h2 class="text-2xl font-semibold text-white">Quick Add</h2>
                        <button onclick="toggleOverlay(false)" class="btn-close"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                    <form onsubmit="handleSave(event)" class="p-6 pt-4 space-y-4 overflow-y-auto flex-1">
                        <div class="flex gap-2 p-1 bg-[rgba(30,41,59,0.8)] rounded-xl">
                            <button type="button" onclick="setFormType('expense')" class="flex-1 py-2 rounded-lg font-medium transition-all ${state.form.type==='expense'?'bg-red-500/20 text-red-400 shadow-lg':'text-gray-400'}">Expense</button>
                            <button type="button" onclick="setFormType('income')" class="flex-1 py-2 rounded-lg font-medium transition-all ${state.form.type==='income'?'bg-emerald-500/20 text-emerald-400 shadow-lg':'text-gray-400'}">Income</button>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">Date</label><input type="date" required value="${state.form.date}" onchange="updateForm('date', this.value)" class="input-field"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">Title</label><input type="text" required placeholder="Starbucks" value="${state.form.title}" oninput="updateForm('title', this.value)" class="input-field"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">Amount</label><input type="number" required step="0.01" placeholder="0.00" value="${state.form.amount}" oninput="updateForm('amount', this.value)" class="input-field"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">Category</label><select onchange="updateForm('category', this.value)" class="input-field">
                            ${cats.map(c => `<option value="${c}" ${c===state.form.category?'selected':''}>${c}</option>`).join('')}
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">Comment</label><textarea rows="2" oninput="updateForm('comment', this.value)" class="input-field">${state.form.comment}</textarea></div>
                        <button type="submit" class="btn-primary w-full mt-4">Save Transaction</button>
                    </form>
                </div>
            </div>`;
        }
        
        function renderSettingsModal(isOpen, settings) {
             if(!isOpen) return '';
             return `
             <div class="fixed inset-0 z-50 overlay-backdrop flex items-center justify-center p-4 animate-fade-in" onclick="if(event.target===this) openSettings(false)">
                <div class="glass-card w-full max-w-sm animate-slide-up p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-white">Settings</h2>
                        <button onclick="openSettings(false)" class="btn-close"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                     <div class="space-y-4">
                        <div><label class="block text-sm text-gray-400 mb-2">Monthly Budget</label><input type="number" value="${settings.monthlyBudget}" id="set-budget" class="input-field"></div>
                        <div><label class="block text-sm text-gray-400 mb-2">Savings Goal</label><input type="number" value="${settings.savingsGoal}" id="set-goal" class="input-field"></div>
                        <button onclick="saveSettingsForm()" class="btn-primary w-full mt-4">Save</button>
                    </div>
                </div>
             </div>`;
        }

        // --- ACTIONS ---

        function toggleOverlay(show) {
            state.showOverlay = show;
             // Reset form on open
            if(show) state.form = { title: '', amount: '', category: 'Other', comment: '', type: 'expense', date: new Date().toISOString().split('T')[0] };
            renderApp();
        }
        
        function openSettings(show = true) {
            state.showSettings = show;
            renderApp();
        }
        
        function saveSettingsForm() {
            const b = document.getElementById('set-budget').value;
            const g = document.getElementById('set-goal').value;
            const data = getData();
            data.settings.monthlyBudget = parseFloat(b);
            data.settings.savingsGoal = parseFloat(g);
            saveData(data);
            state.showSettings = false;
            renderApp();
        }

        function selectMonth(i) {
            state.selectedMonth = i;
            renderApp();
        }

        function toggleExpand(id) {
            state.expandedId = state.expandedId === id ? null : id;
            renderApp();
        }

        function deleteTx(id) {
            if(!confirm('Delete this transaction?')) return;
            const data = getData();
            data.transactions = data.transactions.filter(t => t.id !== id);
            saveData(data);
        }

        function setFormType(type) {
            state.form.type = type;
            renderApp();
        }

        function updateForm(field, value) {
            state.form[field] = value;
            if(field === 'title' && value.length > 2) {
                // Auto suggest
                 for (const [cat, keys] of Object.entries(categoryKeywords)) {
                    if (keys.some(k => value.toLowerCase().includes(k))) {
                        state.form.category = cat;
                        break;
                    }
                }
            }
            // We just updated state, but input focus might be lost if we re-render whole app on every keystroke.
            // For simple HTML app, better NOT to re-render on keystroke, only on significant events.
            // The form values in HTML input are preserved? No, re-render kills them.
            // FIX: Don't re-render on text input. Only on type switch or submit.
            // The renderOverlay retrieves values from state.form.
            // But we can't re-render while typing.
        }
        
        // Fix for input focus lost: Modify renderApp to NOT re-render if overlay is open and we are just typing?
        // Actually, for this simple file, let's just NOT re-render on updateForm.
        // updateForm just updates the state variable.
        // renderApp() reads from state variable.
        // The HTML inputs will hold their own state until I re-render.
        // But renderOverlay sets value="${state.form.amount}".
        // So I must ensure state matches input before any re-render.
        
        function handleSave(e) {
            e.preventDefault();
            const form = state.form;
            const data = getData();
            
            const newTx = {
                id: Date.now().toString(),
                createdAt: new Date(form.date + 'T12:00:00').toISOString(),
                title: form.title,
                amount: parseFloat(form.amount),
                category: form.category,
                type: form.type,
                comment: form.comment
            };
            
            data.transactions = [newTx, ...data.transactions];
            saveData(data);
            toggleOverlay(false);
        }

        // Init
        renderApp();
    </script>
</body>
</html>
